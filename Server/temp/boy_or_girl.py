import os
import math
from flask import Flask, request, redirect, url_for, make_response
import numpy as np
from werkzeug import secure_filename
from rotate import rotate
from find_rect_range import find_rect_range
import dlib
from imread_with_EXIF_orientation import imread_with_EXIF_orientation
from feedforward import feedforward

predictor_path = r"/var/local/magic_mirror/shape_predictor_68_face_landmarks.dat"
predictor_path = r"C:\Users\Miotio\Dropbox\Programming\python\faceArt\landmarks\shape_predictor_68_face_landmarks.dat"
detector = dlib.get_frontal_face_detector()
predictor = dlib.shape_predictor(predictor_path)

weights = [[[-2.337665474708366, -1.2952507930104962, 4.093552845311534, -0.4804103816987628, -1.4237117528520713, 0.2379277230357013, -0.7026053789588266, -0.530103473719777, -1.5089147399176661, -0.2569227175633964, 3.005665386266777, 0.6407452807745415, -1.2320928158061926, -0.10841692069023348, -0.2274757076910267, -4.164561231505662, 1.905238910140176, 4.2040258212549215, -1.4406791381411879, -2.606585198318795, -0.1704314289690549, -0.41892774780849856, 2.1500856413915748, 0.1243637421943978, -1.4751166395947553, -0.8043810419125381, -0.772392184756538, 0.6794220811076466, -0.6196702470242406, -0.9705136166479701, 4.256461357681989, 0.23180894849475, -3.0037665888631526, -1.215672852561363, 0.2586432680682791, 4.681318738500062, -3.709415005688747, -1.2746178367070835, -0.7140492734834192, 1.3783533645054065, 1.7077468523430401, -0.26637774046707424, 3.110588657000223, -4.34141685564505, 4.326334360390867, -4.66776010570314, 0.3819073710547787, 0.09857081161195103, 1.0196133561278307, 2.1498392880303046, -3.4661012144782455, -0.8892267020156402, -0.4996484646239, 4.070661312365237, -0.30673890097135253, 2.2665024103274893, 1.7076490777959363, -0.02969237191774098, 1.9058640628297567, 1.4226580430228992, 2.080744185513831, 2.0399448635334703, -4.152779681824909, -6.112887853215767, 0.5042361401472366, -0.4062759731162926, 1.4565634769588784, 1.5767656146511793, 0.7195619594341732, -0.7809843975913828, -3.4132964493728597, -4.422911180249065, 1.9936359545540143, -2.438336165819249, 0.4480438305181805, 0.2646517102468837, 0.9638715335517729, 2.408686155199063, 0.31250137642534176, -3.0679507915431503, 0.3195845922213834, 2.3614041963600054, -1.9846297205829746, -0.026197706887921387, -0.1706254786424562, -2.9811886192589383, 0.521543255037942, 2.4772259376271673, 1.0331594309553438, 1.3714964223030752, 4.050980610201738, -3.701968861968572, -1.3899611307726485, -1.1111441933457988, -1.303395063062904, 1.7623402985108763, 1.0272357294770385, 1.7123954591880728, -1.328362006001461, 0.9303585769349836, -0.1589167726587264, 0.834971925572832, 0.6268945408069012, 3.9199057633268626, 0.259006537234649, 0.7355464765516319, -2.0886826113136214, -0.017351628735119317, 0.48860731743177854, 2.001280199625006, 0.5340737978099931, -0.2294111222733602, -0.9189460496249788, -1.7515167956141946, 2.5663573399767756, 0.6432659993184203, -1.2640285796655815, -0.789202110042818, 1.8069030730165025, 0.007450433263322213, -2.307050726301587, -0.3708288338083159, 0.03177040703546684, -3.095937010241358, 2.988355073003263, 1.7806677593124347, 0.1777377642960905, -2.797697044493476, -1.5727774098082448, 0.5359016530274922, -0.6936334777016602, -1.0162468935700038, 2.316327323455458, 3.8514094068890756, -0.168763722980476, -1.3960931976392517, 1.3766284243346805], [0.7955357077610138, 0.9905924868406224, -1.4186928250267392, 0.2403634511999439, 0.03456063670297384, -0.8943479699535124, -0.791912381026336, 0.9610784694906884, 1.0612937125446549, 1.8467005285407116, 0.18740134611051582, -0.6583330921794556, 0.2429763121004793, -0.7424939236820552, 1.3080891469914528, 0.6149726593151306, -0.10451845026175115, -3.075577585147586, 1.675776771324632, 0.5205046942968651, 0.39975325177726806, 0.2899757898397775, -0.3255084523802307, -1.1736034383245904, 0.5423838307936928, 1.7026859388762525, 1.1290987532269303, 0.16903393677117762, -0.183383506786985, -0.5215849919861425, -2.513218544487431, 0.324842150258008, 1.3300408002405357, 1.3659050910776485, 0.06985819975190481, -2.9861266762532206, 1.5197604782981287, -0.14408956171360018, 0.7905574259183465, -0.5339139406089647, 0.7321974269279089, -1.2092015764925765, -1.5126966861588498, 0.66336873521637, -1.0520274109065622, 1.9372554738199055, -1.2856275074380072, -0.6990268392477262, 0.553979959096012, 0.3829975926979485, 2.443241643523308, 0.10198202912055246, 0.43954071277372797, -3.8044556581093767, -0.5834462787468686, 0.46868038377223903, -0.8007814100711926, -0.15048058479031207, 0.2822150980411822, -0.026671660934640556, 0.9892286644995151, 0.26833389406077635, 0.7958029558198723, 0.8038514177286745, 0.5597693074771721, 0.8822091942789589, -2.5835332510969096, -1.2535238306447538, -0.7764211525883115, -0.37753145632814095, 1.933988463994057, 1.1813777643431547, 0.45316740777235986, 0.3778527974838137, 0.16987894758848066, -0.13532384998578004, -0.7127169810188774, -1.1886407638018317, -1.3027799844619417, 1.1514707892751475, 0.31023043280786716, -0.045024539272280305, -0.10784867078177689, 0.6593676979082406, -0.5227265762370804, 0.9732826201283135, -1.2734932174818776, -0.9464930520777909, -0.008063291038116874, 1.0016483947094819, -0.9015832313925443, -0.20394382708616843, 0.6676119309794044, 0.50784950667908, -0.29627378956152045, -1.1080034026481216, -1.3201734987365106, -0.5542629237694611, -0.14489032091446907, 0.16391562724667533, 0.13234291480588634, -0.5639197230200581, 0.13750037162929732, -1.012339364553999, 0.13350979393403514, -0.3257629610508092, 2.274860246170314, -0.26614360566529993, -2.1105397159348316, -0.11231955473816436, -0.3225816276944782, -0.3780378176446919, 0.9799720987624863, 2.592706524109674, -1.4878807353520076, 2.153273808495681, 1.017455520138735, 0.7516307825252561, 0.9713997029620113, 0.21269646023381478, 1.2777435250831486, -0.7979948175422963, -0.6629099115323533, 0.5356722965539578, -1.6560937852832505, -1.8153458131380258, -0.6193314795201686, 0.6959962735580594, 1.1383740644274656, -1.497166645381062, -0.423635876636147, 3.003084905015752, -1.5128279319416256, -1.7733179758949313, 1.0208922129195952, 1.85868141347991, -1.3935072442402723]], [[-1.4797587025186254, 0.5114722838137057, 0.7443497133284867]]]
weights = [[[-5.389078762718342, -4.0713677453363495, 9.387938086604004, -0.28348401964232056, -1.7250385811619626, 0.2639854895147078, -1.740492935830756, -2.6179065914991466, -3.159964713544571, -2.303431842449734, 5.568969994979591, 2.695280775373615, -1.5540320811895243, -1.348249690939899, -2.943343794809159, -8.65425528589603, 6.227567112171775, 8.54233011460769, -5.2362207830506176, -6.540431643263337, -0.5281602658574873, -0.4091181330027468, 4.448685889283134, 1.098979695048361, -2.1514379558883916, -3.772153905932997, -2.2463964831056336, 0.07227446974640038, 0.6572153011958721, -1.4898651730359733, 7.63950716041212, 1.511682759862431, -6.598283871893387, -4.833073379362653, -0.7556543239559917, 14.181773119517404, -10.390429211927136, -3.461282115360637, -0.6591525450527762, 3.3242693179115492, 4.322826373173699, -0.19604831646091161, 7.115069480004106, -10.272239107905166, 9.968456604899629, -10.541393612420576, 4.184374592553136, 0.046054866199498126, 2.5435303846193333, 4.386007426229161, -12.047479626470386, -2.9337728110912886, -1.3191897823101428, 13.86847814960525, -0.30673890097135253, 3.7011391487037058, 4.190383621910982, -0.1454087724634924, 4.855124397858374, 2.9402096798103456, 5.004043617376988, 5.929738042950865, -7.237049295477393, -14.396697284185601, 0.9807558429161864, -1.3036999678287597, 2.1945207335524097, 3.7959531380754443, 0.9108398913300108, -2.1335790458356425, -7.783385465226611, -9.645937000299917, 3.9440760194938562, -5.6973160361935795, 1.136970912056852, 2.5462299891662785, 2.5836495373738484, 5.729707881507378, 0.05238489275771806, -6.739171691563655, 1.106843893158627, 4.663770046587917, -2.738132997729374, 0.057897621605490494, 0.7940206366557612, -6.628366584604995, 1.8971292126579968, 5.89227000431526, 2.8517436351172964, 2.978840790550492, 8.6417155708797, -7.843524339386181, -2.471535939444208, -2.1141938892660543, -2.5186450555414286, 1.4466026089178836, 1.7926055263460903, 4.99353544187252, -2.487869367204497, 1.1171349825379837, -1.018987478350121, 2.2830528507344887, -1.2074456387532642, 9.541785768440503, -0.39780569448341896, 1.7449413754143976, -4.356326535728798, 1.5953291324881174, 1.4605084297353825, 5.2937315362075745, 0.20966428950369614, -0.6440779873524911, -1.0751324215937075, -7.392459479355315, 4.000994078352432, 0.6432659993184203, -2.483757635567658, -4.024856615222787, 4.775292405410233, 0.960214025151909, -5.520179792780529, -1.4999258611849395, 2.189285544642253, -5.739583657677548, 5.724894737055511, 2.6511939755842633, 3.25753262527777, -6.407314904788612, -4.769380427650765, 2.908486789768836, -0.8785155768322547, -2.968646666359545, 2.0799134591850255, 6.06665011165357, -0.12174063975570361, -3.5739396972842785, 5.202280301063377], [-0.37883724522305384, 3.2527097376609473, -3.19283524186787, 1.126649642372562, 0.8749652285044398, -0.9404893411688008, 0.21028158300800964, 2.6113659381466174, 2.1509942788697187, 2.273039898174628, 0.055075463422973876, -2.1207511646353066, -0.17956699431499748, -2.81578719674049, 0.5792529863492575, -1.0825962504933992, -0.6945424188095083, -4.165504641976397, 3.2234201976930117, 2.5223660111094675, 1.4895074411212321, 2.0248740554933375, -0.07324630472506359, 0.8746682805668038, 0.9568469520941947, 3.414317204508997, 0.0033061541033167405, -1.050708864466825, -3.162696340434866, -2.763732406664364, -4.810510012089303, -1.1574903678564419, 3.448529080368971, 0.931378492158597, -0.044969005984239155, -3.8157304931701335, 1.7498288432400833, 0.28730042770095127, 0.0837624247522463, -1.4809001495287686, -0.5739060400951485, -1.7476851484186493, -3.051091356956602, 1.9736942425906774, 0.021080400669515918, 4.943790930529439, -0.9730364336621229, -0.1285289975535291, 1.8463580040030267, 1.1376241924702648, 5.315644177833596, 0.6459103607324409, 0.6600737923143131, -6.370797741042058, -0.5834462787468686, 0.3555290505673269, -1.0279342000999792, -0.5492405454570201, -0.2318162269264338, -1.0586160992828006, -0.030283424902995314, -1.5361143475574905, 3.4179453689842245, 2.889926729045819, -0.0840365624677411, 2.225245392944864, -3.6951391715739534, -0.7055948595916581, -0.8496521810299752, -0.13051227417162542, 3.7197914613927576, 0.5661749825338508, 0.1109430982271796, 0.8487550645372901, 0.5116975228264644, -0.07956829830386701, -0.30288542721507844, -1.3034784991100106, 1.0198132408299148, 1.9220899022578506, 0.932580880482899, -1.0849767023272614, 1.3113545369868562, 1.1088065200720052, -1.9669768896263264, -0.04074625949659797, -2.168192243146621, -2.1861867907292383, -0.32469246943892716, 0.07177861757492439, -0.583617025905533, 1.2996840533004543, 0.9336972379048656, -0.27052674365591006, -1.0979688192011345, -2.717247263719289, -0.4323324283171194, -3.6856824441918055, 0.654006378412794, 1.2873574658953244, -0.13365060218057132, 0.8122855850054648, -0.21297599240919218, -1.2576912107356888, -0.40237138843252873, -1.4715178958235966, 1.9201865641824378, -1.920503765214723, -3.4804417252614828, 2.352258452814912, -0.7759156819149257, -0.4819554420900191, 1.0117709974713984, 2.7065289424643892, -1.6010320685563946, 2.153273808495681, 1.3553539174386393, 0.6796789081534905, 1.1509626913033741, -1.0787863117066308, 2.0064763927797253, -2.852501034429711, -0.08793194380418486, 1.549135347571992, -1.7791491853293633, -1.5472646669508676, -1.723154111290831, 1.5430055908490117, 1.3620149450585752, -0.34145029027411533, -1.0535335973791637, 3.082937597519443, -1.1135791169934355, -2.451108735251525, 1.2587566812655417, 3.114360461800962, -0.6130864292432091], [3.856228544082039, 0.71795008005552, -0.5435768581802966, -1.2581597134939986, -1.3720550115068384, -3.491768318704135, -2.7253396773555827, -2.124287074189029, 0.5975230669143886, 2.7076043969246846, -1.6628857543536621, 2.3457866420246942, 0.3489001582934426, 1.7693389903971704, 2.5320375048924255, 3.32379849438659, -0.6641409853433861, -2.549864114657941, 1.0140210854517133, -2.488645953453024, -0.9521479029342563, -1.6083495551127702, -1.6800234109134558, -1.3923211306009948, 2.3305434112963854, 0.3337627672535895, 0.6711827751708015, 0.4536077933648043, 2.8164595197670828, 0.9297455278910665, -1.1764013188104265, 1.769700575699504, 0.6131541507788922, 1.8773017838599602, 0.40297844710038855, -5.000201876464866, 1.9805691161903465, 1.1353767965233554, 1.3661018545182668, 0.21484465362640306, 2.6009758560330103, 1.4114091550131231, 0.5349312811209771, 0.2637274077023063, -3.5491143022972147, 1.6092728708513468, -0.33783753633461105, -2.2270900031325653, -0.04548757267355566, -3.618232082838669, -0.04773748723350211, -0.8598740843356351, 0.4102669936370443, -0.3626016714314126, 0.5282653434093696, -0.6381760391275945, 0.01506196882505817, -0.3260377902014769, 0.2814013717926106, 1.254929660261925, -1.5428904203285478, -1.83148187460506, 1.2415795120528792, -0.42637607912468833, -2.4673239306039085, -0.995796760108242, -1.4996768295849026, -1.2724111791745596, -2.106833996856902, 0.8372846418871512, 1.134915219560337, 3.22627083305605, -0.5371381826640017, 1.5387581906693548, 0.5738581079936239, 0.5611838318730923, -3.572067742584395, -2.1632936277531614, -2.260682976478269, 0.5806512351106701, -1.2619211314013952, -0.7556404555036972, 0.5984458403849451, -1.3845124227776926, 0.467431199419616, 3.197041396220767, -1.9698089428649501, 0.6633265472923779, -0.6060300828338949, -0.17092812225589107, -0.7420887275209656, 2.9709481789054237, 0.13985436844293597, 0.6487494288032485, 2.0965510443939444, 0.990844792439535, -1.7664583595079362, 4.317997482876143, 0.16340025797879096, -2.257017675634604, 0.19726398148508878, -1.4888122215557635, 0.20999063851222552, -1.9217182837541447, 0.8753624740963987, 0.32155413878742534, 2.909095650512764, 1.06290514218757, -0.8296167695897949, -5.1587445096353655, 0.6233722093216784, 1.1634278887317093, 1.5521545243836192, 1.6749369087211763, 0.686231288422653, 0.38312334130826775, 1.3094309769170356, 0.8006715840961237, -1.1664018204847837, 0.466061172915815, 1.577657830370772, 3.259750539857573, -0.9680803771516984, -0.33360694698937754, -1.3844079131116056, -0.5201165427723387, 0.5698503889207688, 1.2831294310605956, 1.076118674821318, -1.5662422271130654, 0.3554655618292408, 1.4061997382410925, -0.5894966078814684, -1.749998246501684, -2.133041142213965, 0.051354473256448575, -1.6402760684297935]], [[-0.5987345652390724, 0.26510753454277736, 0.2900721385437318, 0.6492699107993293]]]
static_submit_form =  "<html><body>" + open("static_html.template","r").read()

print("Привет!")
UPLOAD_FOLDER = './img/'
ALLOWED_EXTENSIONS = set(['jpg','jpeg','png'])

app = Flask(__name__)
app.config['MAX_CONTENT_LENGTH'] = 12 * 1024 * 1024
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
app.debug = False

def allowed_file(filename):
	return '.' in filename and \
		   filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def normalized_landmark_vector(landmarks):
	""" Нормализация "волшебных" точек
		На данный момент:
			Вертикальная ориентация лица
			Приведение к единичному масштабу
	"""

	# Считаем угол таким образом, что положительное направление - склонённость к правому плечу
	# Центр - 28-я точка - т.е. landmarks[27]

	nose_bridge = landmarks[27]

	eyes_vector_x, eyes_vector_y = landmarks[45][0] - landmarks[36][0], landmarks[45][1] - landmarks[36][1]
	angle = - math.atan(eyes_vector_y / eyes_vector_x)
	
	
	#print("Угол равен %f градусов (наклон к правому плечу)" % (angle * 180 / math.pi))
	verticalized = [rotate((x,y), origin = nose_bridge, angle = angle) for (x, y) in landmarks]

	# Временно - как хеш лица используем только глаза
	# verticalized = verticalized[42:48] + verticalized[36:42]

	((x1, y1), (x2, y2)) = find_rect_range(verticalized)
	width = x2 - x1
	height = y2 - y1
	
 
	normalized = verticalized
	normalized = [((x-x1) / width, (y-y1) / width) for (x, y) in verticalized]
	return normalized
		   

def distance(x1,y1, x2, y2):
	return math.sqrt( (x1-x2)**2 + (y1-y2)**2)

def magic_distances_from_landmarks(a):


	# Первая опорная точка
	xc1 = a[27][0]
	yc1 = a[27][1]


	# Вторая опорная точка
	xc2 = a[57][0]
	yc2 = a[57][1]


	distances = []

	for (x, y) in a:
		"""
		x.append(i[0])
		y.append(i[1])
		"""
		

		d1 = distance(x,y, xc1, yc1) 
		d2 = distance(x,y, xc2, yc2) 
		
		distances.append(d1)
		distances.append(d2)
	return distances




@app.route("/", methods=['GET', 'POST'])
def index():
	if request.method == 'POST':
		print("Заголовки request.headers: ", request.headers)
		file = request.files['file']
		print("Файлы request.files=%s" % request.files)
		if file and allowed_file(file.filename):
			print("Сохраняем файл")
			filename = secure_filename(file.filename)
			full_filename = os.path.join(app.config['UPLOAD_FOLDER'], filename)
			file.save(full_filename)
			print("Сохранили файл")


			img = imread_with_EXIF_orientation(full_filename) # Считали картинку и поместили ее в ndarray
			faces, confidence, idx = detector.run(img, 1)

			shape = predictor(img, faces[0])
			distances = magic_distances_from_landmarks(normalized_landmark_vector([(shape.part(i).x, shape.part(i).y) for i in range(0, 68)]))
			result = feedforward(distances, (2, 1), weights)
			return "<h2> Result: " + str(result) + "</h2>"+ static_submit_form


		else:
			return '{"Error":"1236","ErrorText":"Bad file format"}'
	#return  "Тут мы ждем файлик!"
	return static_submit_form
	

print("Сейчас будем запускать сервер!")
if __name__ == "__main__":
	app.run(host='0.0.0.0', port=8888)